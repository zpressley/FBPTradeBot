name: Daily Data Pipeline

on:
  schedule:
    # Run daily at 6am EST (11am UTC)
    - cron: "0 11 * * *"
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup credentials
      run: |
        echo '${{ secrets.YAHOO_TOKEN_JSON }}' > token.json
        echo '${{ secrets.GOOGLE_CREDS_JSON }}' > google_creds.json
    
    - name: Run Smart Data Pipeline
      run: |
        # The smart pipeline automatically detects season phase
        # and only runs necessary updates
        python3 data_pipeline/smart_update_all.py
    
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Daily data update - $(date)" && git push)

    - name: Resolve weekly auction (Sundays only)
      if: "${{ github.event_name == 'schedule' && startsWith(github.event.schedule, '0 18') }}"
      # 18:00 UTC ~= 2pm ET during standard time; adjust if needed for DST.
      run: |
        python3 scripts/resolve_auction.py
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/combined_players.json data/wizbucks.json data/auction_current.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ Resolve weekly auction - $(date)" && git push)
