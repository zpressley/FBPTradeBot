name: Daily Data Pipeline

permissions:
  contents: write

on:
  schedule:
    # Run daily at 6am EST (11am UTC)
    - cron: "0 11 * * *"
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    env:
      FBP_HUB_PUSH_TOKEN: ${{ secrets.FBP_HUB_PUSH_TOKEN }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup credentials
      run: |
        echo '${{ secrets.YAHOO_TOKEN_JSON }}' > token.json
        echo '${{ secrets.GOOGLE_CREDS_JSON }}' > google_creds.json
    
    - name: Run Smart Data Pipeline
      run: |
        # The smart pipeline automatically detects season phase
        # and only runs necessary updates
        python3 data_pipeline/smart_update_all.py

    - name: Commit and push if data/ changed (fbp-trade-bot)
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Stage only data/ so secrets in token.json/google_creds.json never
        # affect this commit step. We intentionally ignore working-tree
        # changes outside data/ (like token.json).
        git add data/

        # If there are no staged changes under data/, exit successfully
        # without committing.
        if git diff --cached --quiet; then
          echo "No data/ changes to commit."
          exit 0
        fi

        git commit -m "üîÑ Daily data update - $(date)"
        git push

    # Optional: sync Top 100 prospects into the fbp-hub repo for the website.
    # This assumes you have created a personal access token with repo write
    # access to the fbp-hub repository and stored it in the secret
    # FBP_HUB_PUSH_TOKEN. Adjust the `repository` value if your GitHub org/user
    # or repo name differs.
    - name: Checkout fbp-hub repository
      if: ${{ env.FBP_HUB_PUSH_TOKEN != '' }}
      uses: actions/checkout@v3
      with:
        repository: "zpressley/fbp-hub"
        path: fbp-hub
        token: ${{ env.FBP_HUB_PUSH_TOKEN }}

    - name: Update top100_prospects.json in fbp-hub
      if: ${{ env.FBP_HUB_PUSH_TOKEN != '' }}
      run: |
        python3 data_pipeline/update_top100_prospects_for_hub.py --hub-path fbp-hub

    - name: Commit and push Top 100 to fbp-hub
      if: ${{ env.FBP_HUB_PUSH_TOKEN != '' }}
      working-directory: fbp-hub
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/top100_prospects.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "üîÑ Update top100_prospects from pipeline - $(date)" && git push)

    - name: Resolve weekly auction (Sundays only)
      if: "${{ github.event_name == 'schedule' && startsWith(github.event.schedule, '0 18') }}"
      # 18:00 UTC ~= 2pm ET during standard time; adjust if needed for DST.
      run: |
        python3 scripts/resolve_auction.py
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/combined_players.json data/wizbucks.json data/auction_current.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "üèÅ Resolve weekly auction - $(date)" && git push)
