# KAP Buy-In Integration

## ‚ö†Ô∏è Critical: KAP Spending Flow Architecture

### Buy-Ins = ONLY Mid-Stream Purchase
Buy-ins are the **ONLY** action in KAP that causes an immediate spend. Everything else is staged/preview until final KAP submission.

**Immediate Purchase (Mid-Stream):**
- ‚úÖ Buy-In Rounds (R1, R2, R3) ONLY
- Has confirmation modal with warnings
- "This is immediate and NON-REFUNDABLE"
- Instantly deducts from wallet
- Posts to Discord immediately
- Syncs across all pages

**Staged Until Final Submission:**
- ‚è∏Ô∏è Keeper selections
- ‚è∏Ô∏è Taxable spending calculations
- ‚è∏Ô∏è Draft pick preview
- ‚è∏Ô∏è Tax bracket validation

Managers can adjust everything freely until they click "Submit KAP" at the end. Buy-ins require explicit confirmation since they're irreversible.

## Overview
Buy-ins are **independent purchases** that happen immediately, not during KAP submission. They sync between KAP page and Draft Picks page.

## Key Principles

### 1. Immediate Purchase
- Purchase happens NOW, not when KAP is submitted
- Deducts from KAP allotment immediately
- Updates taxable spend immediately
- Posts to Discord immediately

### 2. Cross-Page Sync
- Purchase on Draft Picks page ‚Üí Shows "Already Purchased" in KAP
- Purchase on KAP page ‚Üí Shows "Already Purchased" on Draft Picks
- Both pages read from same source: `draft_order_2026.json`

### 3. Effects on Draft Picks
- Each buy-in removes 1 round from the end:
  - 0 buy-ins: Rounds 1-29
  - 1 buy-in: Rounds 1-28 (lose R29)
  - 2 buy-ins: Rounds 1-27 (lose R28-29)
  - 3 buy-ins: Rounds 1-26 (lose R27-29)

## User Flow

### On KAP Page
```
1. Manager sees buy-in section with 3 cards
2. Card shows: "Not Purchased" or "Already Purchased"
3. Click "Purchase" ‚Üí Confirmation modal appears
4. Modal shows:
   - Cost and balance check
   - "This is immediate and non-refundable"
   - Effects list (what will happen)
5. Confirm ‚Üí API call ‚Üí Immediate update
6. Success toast notification
7. Card updates to "Already Purchased"
8. Taxable spend counter updates
```

### Confirmation Modal Content
```
‚ö†Ô∏è This purchase is immediate and NON-REFUNDABLE
The buy-in will be purchased now, not when you submit KAP.

Round 1 Buy-In
Cost: $55 (taxable)
Your KAP Balance: $375
Remaining After Purchase: $320

Effects:
‚Ä¢ Deducted from KAP allotment immediately
‚Ä¢ Added to taxable spend
‚Ä¢ Enables trading picks in Round 1
‚Ä¢ Removes Round 28 from available picks

[Cancel]  [Confirm Purchase]
```

## API Integration

### Endpoint
```
POST /api/buyin/purchase
```

### Request
```json
{
  "team": "WIZ",
  "round": 1,
  "cost": 55,
  "purchased_by": "username"
}
```

### Backend Actions
1. Validate funds in `managers.json`
2. Update `draft_order_2026.json`:
   - Set `buyin_purchased: true`
   - Set `buyin_purchased_at: timestamp`
   - Set `buyin_purchased_by: username`
3. Deduct from KAP balance in `managers.json`
4. Log transaction in `wizbucks_transactions.json`
5. Post to Discord channel

### Response
```json
{
  "success": true,
  "remaining_balance": 320
}
```

## Frontend Integration

### HTML Structure
```html
<!-- In kap.html -->
<div id="buyinSection">
    <div class="section-header">
        <i class="fas fa-info-circle"></i>
        <h3>Buy-In Rules</h3>
    </div>
    <p>Buy-ins are taxable spend. Needed to trade picks in Rounds 1-3.</p>
    
    <div id="buyinCardsContainer" class="buyin-cards-grid">
        <!-- Cards generated by JS -->
    </div>
</div>
```

### Initialization
```javascript
// In kap.html or kap.js
document.addEventListener('DOMContentLoaded', async () => {
    const team = authManager.getTeam().abbreviation;
    
    // Initialize buy-in section
    await initKAPBuyins(team);
    
    // Rest of KAP initialization...
});
```

### Taxable Spend Integration
```javascript
// In main KAP calculation
function calculateTotalTaxableSpend() {
    const buyinSpend = getTotalBuyinSpend(); // from kap-buyin-integration.js
    const freeAgents = calculateFASpend();
    const contracts = calculateContractSpend();
    
    return buyinSpend + freeAgents + contracts;
}
```

## State Management

### Global State
```javascript
window.kapState = {
    team: "WIZ",
    kapBalance: 375,
    otherTaxableSpend: 0,  // FA + contracts + etc
    buyins: {
        1: { purchased: false, cost: 55 },
        2: { purchased: false, cost: 35 },
        3: { purchased: false, cost: 10 }
    }
};
```

### After Purchase
```javascript
// Automatically updates:
- buyinStatus[round].purchased = true
- Taxable spend counter
- KAP balance display
- Draft pick preview (when shown)
```

## Draft Pick Preview Integration

When showing the draft pick preview (before final KAP submission):

```javascript
// Load current buy-in status
const buyinStatus = await loadBuyinStatus();
const buyinCount = countBuyins(teamPicks);

// Show in preview:
"Buy-Ins Purchased: 2"
"Max Available Round: 27"

// Show removed picks:
"üõí Picks Removed (Buy-In Penalty)
‚Ä¢ Round 28 - Pick #331
‚Ä¢ Round 29 - Pick #343"
```

## Files Structure

### JavaScript
- `kap-buyin-integration.js` - Buy-in purchase logic
- `kap-draft-calculator.js` - Draft pick preview with buy-ins
- `kap.js` - Main KAP form logic (to be created)

### CSS
- `kap-calculator.css` - Modals, toasts, effects display

### Data
- `draft_order_2026.json` - Source of truth for buy-in status
- `managers.json` - KAP balances
- `wizbucks_transactions.json` - Transaction log

## Testing Checklist

### Purchase Flow
- [ ] Click Purchase ‚Üí Modal appears
- [ ] Insufficient funds ‚Üí Button disabled
- [ ] Confirm ‚Üí API call succeeds
- [ ] Card updates to "Already Purchased"
- [ ] Taxable spend increases by cost
- [ ] Success toast appears
- [ ] Discord notification posted

### Cross-Page Sync
- [ ] Purchase on KAP ‚Üí Shows on Draft Picks
- [ ] Purchase on Draft Picks ‚Üí Shows on KAP
- [ ] Refresh page ‚Üí Status persists

### Draft Preview
- [ ] Buy-in count shown in preview
- [ ] Max round calculated correctly
- [ ] Removed picks shown separately
- [ ] Final picks exclude buy-in penalty rounds

## Error Handling

### Insufficient Funds
```
Modal shows:
‚ùå Insufficient KAP Balance
You need $55 but only have $50 available.

Button is disabled.
```

### API Failure
```
Alert: "Failed to purchase buy-in: <error message>"
State not updated
User can retry
```

### Already Purchased
```
Card shows: "Already Purchased"
Button disabled
No modal appears
```

## Discord Notification Example
```
üéØ Draft Pick Buy-In Purchased

WIZ purchased Round 1 buy-in

Team: WIZ
Round: 1
Amount: $55
```

## Implementation Checklist

- [x] Create `kap-buyin-integration.js`
- [x] Add toast notification styles
- [x] Add buy-in effects modal
- [ ] Update `kap.html` with buy-in section
- [ ] Connect to main KAP form state
- [ ] Test purchase flow
- [ ] Test cross-page sync
- [ ] Test draft preview integration
- [ ] Deploy backend API (already exists)
- [ ] Update Cloudflare Worker (already done)
